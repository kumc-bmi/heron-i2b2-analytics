---
title: "Create a sparse matrix from EHR data"
author: "Steve Simon"
date: "6/5/2018"
output: html_document
---

This program shows how to take information in the electronic health record and convert it to a sparse matrix format.

Please review open_oracle.Rmd to review how to access information in an Oracle database.

```{r timing-functions}
program_name <- "create_sparse_matrix"
timing_file <- paste0("../src/", program_name, "_timing.txt")
image_file <- paste0("../data/", program_name, ".RData")

library(knitr)
log_time <- function(first=FALSE) {
  current_chunk <- opts_current$get("label")
  current_time <- as.character(Sys.time())
  cat(current_time, current_chunk, "began.\n", file=timing_file, append=!first)
}
```

```{r login-to-oracle}
log_time(first=TRUE)
library("dplyr")
library("magrittr")
library("ROracle")
cdm_config <- read.csv('../cdm_config_B2.csv', stringsAsFactors=FALSE)
c_connect <-
  dbConnect(Oracle(), cdm_config$account, cdm_config$password, cdm_config$access)
```

Run a simple test to see that the connection works. 

```{r simple-test}
log_time()
dbGetQuery(c_connect, "SELECT * FROM blueherondata.observation_fact WHERE rownum < 5")
dbGetQuery(c_connect, "SELECT * FROM blueherondata.concept_dimension WHERE rownum < 5")
dbGetQuery(c_connect, "SELECT * FROM blueheronmetadata.heron_terms WHERE rownum < 5")
```

Start small.

```{r medication-concepts}
log_time()
sql_medication_concepts <- "
SELECT DISTINCT concept_cd FROM blueherondata.concept_dimension
WHERE concept_path LIKE '\\i2b2\\Medications\\%'
ORDER BY concept_cd
"
db_medication_concepts <- dbGetQuery(c_connect, sql_medication_concepts)
sample_n(db_medication_concepts, size=10)
dim(db_medication_concepts)
```


```{r diabetes-patients}
log_time()
sql_patients_and_concepts <- "
SELECT patient_num concept_cd
FROM blueherondata.observation_fact
WHERE patient_num IN (
  SELECT patient_num, MIN(start_date) AS pdate
  FROM blueherondata.observation_fact
  WHERE concept_cd IN (
    SELECT DISTINCT c_basecode 
    FROM blueheronmetadata.heron_terms
    WHERE
      c_tooltip LIKE '%250 Diabetes mellitus%' OR
      c_tooltip LIKE '%E08-E13 Diabetes mellitus%'
     )
  GROUP BY patient_num
  ORDER BY patient_num
)
AND concept_cd IN (
  SELECT DISTINCT concept_cd FROM blueherondata.concept_dimension
  WHERE concept_path LIKE '\\i2b2\\Medications\\%'
  ORDER BY concept_cd
)"

sql_alternate_count <- "
SELECT patient_num concept_cd
FROM blueherondata.observation_fact
WHERE concept_cd IN (
  SELECT DISTINCT concept_cd FROM blueherondata.concept_dimension
  WHERE concept_path LIKE '\\i2b2\\Medications\\%'
)
AND patient_num IN (
  SELECT DISTINCT patient_num
  FROM blueherondata.observation_fact
  WHERE concept_cd IN (
    SELECT DISTINCT c_basecode 
    FROM blueheronmetadata.heron_terms
    WHERE
      c_tooltip LIKE '%250 Diabetes mellitus%' OR
      c_tooltip LIKE '%E08-E13 Diabetes mellitus%'
  )
)
"

tst1 <- dbGetQuery(c_connect, sql_alternate_count)
dim(tst1)
# dbGetQuery(c_connect, sql_patients_and_concepts)
```

Get counts.

```{r distinct-counts}
tst1 %>%
  select(patient_num) %>%
  distinct %>%
  nrow -> n_patients 

tst1 %>%
  select(concept_cd) %>%
  distinct %>%
  nrow -> n_concepts 

tst1 %>%
  distinct %>%
  nrow -> n_patient_concepts

matrix_size <- as.numeric(n_patients)*as.numeric(n_concepts)
matrix_ratio <- 100*n_patient_concepts/matrix_size

n_patients %<>% format(big.mark=",")
n_concepts %<>% format(big.mark=",")
n_patient_concepts %<>% format(big.mark=",")
matrix_size %<>% format(big.mark=",")
matrix_ratio %<>% round(2)
matrix_ratio %<>% paste0("%")
```

Note that there are `r n_patient` distinct patients and `r n_concepts` distinct medications. If you arranged this in a traditional matrix with one row per patient and one indicator variable for every medication, you would have a matrix with `r matrix_size` entries. But there are only `r n_patient_concepts` unique entries in this database, meaning that only `r matrix_ratio` of the entries would be non-zero.

The sparse matrix format saves space and computation time by storing only the non-zero entries of the matrix, using pointers.

Save everything for later use.

```{r save-everything}
log_time()
read.table(timing_file) 
save.image(image_file)
```