---
title: "Mining the Electronic Health Record, Why and How."
author: "Steve Simon, Department of Biomedical and Health Informatics, UMKC"
date: "4/19/2018"
output: ioslides_presentation
bibliography: ../doc/key-references.bibtex
---

## Abstract

Medical records are now stored electronically, allowing opportunities for research and quality improvement studies that did not exist before. In this talk, I will review the extraction of information into i2b2, a database that is scrubbed of personal identifiers, and will discuss the strengths and limitations of this data compared to other commonly used health care data sets. I will also show a simple example of creating a medical record phenotype and validating it against a tumor registry.

## Do you understand this cartoon?

![](~/heron-i2b2-analytics/bin/bobby-tables-cartoon.png)

## Before the Electronic Health Record.

![](~/heron-i2b2-analytics/bin/paper-health-record.jpg)

## What is the Electronic Health Record?

![](~/heron-i2b2-analytics/bin/ehr-data-entry.jpg)


## Mining the EHR, the old way

![](~/heron-i2b2-analytics/bin/data-in-excel-spreadsheet.jpg)

## What is i2b2?

i2b2 is an acronym:

* Informatics for Integrating Biology and the Bedside.

It has been adopted and aggressively promoted by many hospitals.

## What is i2b2?

It is an example of ETL:

* Extract,
* Transform, 
* Load.

## What is i2b2?

You cannot and should not analyze the EHR as it exists within Cerner and Epic because of

* privacy concerns,
* usability issues.

## What is i2b2?

Cerner and Epic are designed for the care needs of individual patients.

i2b2, in contrast, is designed for research.

* The data is de-identified.
* You can easily extract groups.
* You can integrate other data sets.

## What i2b2 lacks.

i2b2 does not include free text fields (patient notes).

i2b2 does not include information on health care provided to your patients, but provided at other locations.

## i2b2 schema

![Source: @bellazzi2012](~/heron-i2b2-analytics/bin/i2b2-schema.jpg)

## The EAV model

The i2b2 database uses a modified verison of the EAV model. EAV stands for

* Entity
* Attribute
* Value

Longitudinal data has two formats

* "tall and thin" and
* "short and fat".

The EAV model takes "tall and thin" to an extreme.

```{r eav-example, echo=FALSE}
library(knitr)
df1 <- data.frame(
  entity=c("alpha", "bravo"),
  a1=11:12,
  a2=21:22,
  a3=31:32,
  b1=c("a", "b"),
  b2=c("c", "d"),
  b3=c("e", "f"),
  d1=c("1-Jan", "2-Jan"),
  d2=c("1-Feb", "2-Feb"),
  d3=c("1-Mar", "2-Mar"),
  stringsAsFactors=FALSE
)

df2 <- data.frame(
  entity=c(rep("alpha", 5), "..."),
  attribute=c("a1", "b1", "d1", "a2", "b2", " "),
  value=c("11", "a", "1-Jan", "21", "c", " "),
  stringsAsFactors=FALSE
)  
```

## An example of a "short and fat" data set

`r kable(df1)`

## "Short and fat" transformed into the EAV model

`r kable(df2)`

## Another example of the EAV model

```{r wikipedia-example}
# <pt XYZ>, <Temperature in degrees Fahrenheit>, "102"
# <pt XYZ>, <Presence of Cough>, "True"
# <pt XYZ>, <Type of Cough>, "With phlegm, streaks of blood"
# <pt XYZ>, <Heart Rate in beats per minute>, "98"
# ...

```

## Advantages

The advantages of the EAV structure are that

* you are only storing the medications, procedures, and diagnoses that a patient has,

* as new medications, procedures, and diagnoses appear, you can add these without altering the database structure.

The EAV structure is similar to that of a sparse matrix.

## The EAV model requires a lot of self-joins

Example: Get patients with breast cancer diagnosis...

```{r select-bc, echo=FALSE}
cat(
  "SELECT distinct patient_num",
  "  FROM observation_fact",
  "  WHERE concept_cd LIKE 'ICD10:C50%'",
sep="\n")
```

## The EAV model requires a lot of self-joins

Example: ...and restrict to females only...

```{r select-females-only, echo=FALSE}
cat(
  "SELECT distinct patient_num",
  "  FROM observation_fact",
  "  WHERE concept_cd = 'DEM|SEX:f'",
  "  JOIN (SELECT distinct patient_num AS bc_pt",
  "    FROM observation_fact",
  "    WHERE concept_cd LIKE 'ICD10:C50%')",
  "  ON patient_num=bc_pt",
sep="\n")
```

## The EAV model requires a lot of self-joins

Example: ...and get all medical procedures.

```{r select-procedures, echo=FALSE}
cat(
  "SELECT patient_num, concept_cd",
  "  FROM observation_fact",
  "  WHERE concept_cd LIKE 'CPT:%", 
  "  JOIN (SELECT distinct patient_num AS female_pt",
  "    FROM observation_fact",
  "    WHERE concept_cd = 'DEM|SEX:f')",
  "  ON patient_num=female_pt",
  "  JOIN (SELECT distinct patient_nm AS bc_pt",
  "    FROM observation_fact",
  "    WHERE concept_cd LIKE 'ICD10:C50%')",
  "  ON patient_num=bc_pt",
sep="\n")
```

## The problem with self-joins

It's dangerous to generalize too much, but self-joins are often inefficient.

Joining two separate tables

* if you're lucky, the database can often go down record by record in each table.

Self-joins

* if you're not lucky, the database has to store the entire table in memory.

There are always ways to optimize, of course.

## Metadata

The metadata associated with i2b2 is very important. In particular, the concept path shows the hierarchy associated with medications, procedures, and diagnoses.

The metadata also helps with labeling some of the cryptic codes used in the EHR.

## Metadata, diagnoses

Here's an example of the hierarchy for a particular diagnosis.

* concept_cd = ICD10:S35.00XS
* name_char = S35.00XS Unspecified injury of abdominal aorta, sequela
* path level 0 = S35.00 Unspecified injury of abdominal aorta
* path level 1 = S35.0 Injury of abdominal aorta
* path level 2 = S35 Injury of blood vessels at abdomen, lower back and pelvis level
* path level 3 = S30-S39 Injuries to the abdomen, lower back, lumbar spine, pelvis and external genitals
* path level 4 = S00-T88 Injury, poisoning and certain other consequences of external causes
* path level 5 = ICD10

## Metadata, procedures

Here's an example of the hierarchy for a particular procedure.

* concept_cd = CPT:44363
* name_char = Small intestinal endoscopy, enteroscopy beyond second portion of duodenum, not including ileum; with removal of foreign body
* path level 0 = Endoscopy, Small Intestine and Stomal
* path level 1 = Surgical Procedures on the Intestines (except rectum)
* path level 2 = Surgical Procedures on the Digestive System
* path level 3 = Surgical Procedures

## Metadata, medications

Here's an example of the hierarchy for a particular medication.

* concept_cd = KUH|MEDICATION_ID:13878
* name_char = PLENDIL 2.5 MG PO TB24
* path level 0 = Felodipine Extended Release Oral Tablet
* path level 1 = [CV200] CALCIUM CHANNEL BLOCKERS
* path level 2 = [CV000] CARDIOVASCULAR MEDICATIONS

## Metadata, lab tests

Here's an example of the hierarchy for a lab test

* concept_cd = LOINC:3548-5
* name_char = Diazepam SerPl-mCnc (3548-5)
* path level 0 = Diazepam | Bld-Ser-Plas (LP43601-1)
* path level 1 = Diazepam (LP16108-0)
* path level 2 = Benzodiazepines (LP15014-1)
* path level 3 = Tranquilizers (LP30812-9)
* path level 4 = Drugs (LP18046-0)
* path level 5 = Drug/Tox (LP31389-7)

## Alternatives to i2b2, NHAMCS

THe National Hospital Ambulatory Medical Care Survey (NHAMCS) is...

## Alternatives to i2b2, Health facts

![Source: @deshazo2015](~/heron-i2b2-analytics/bin/deshazo-2015-article.png)

## The special needs of data mining

## Application to developing an EHR phenotype

![](~/heron-i2b2-analytics/bin/figure-1.png)

## Application to developing an EHR phenotype

![](~/heron-i2b2-analytics/bin/figure-2.png)

## Application to developing an EHR phenotype

![](~/heron-i2b2-analytics/bin/figure-3.png)

## Bibliography

All images used in this talk are made available through an open source license. You can find the websites where these images came from at https://github.com/kumc-bmi/heron-i2b2-analytics/bin/image-sources.txt

