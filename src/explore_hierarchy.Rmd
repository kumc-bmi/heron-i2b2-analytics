---
title: "Explore the EHR hierachy"
author: "Steve Simon"
date: "5/31/2018"
output: html_document
---

This program shows how to drill down through various levels of the hierarchy in the electronic health record.

Please review open_oracle.Rmd to review how to access information in an Oracle database.


```{r login-to-oracle}
library("ROracle")
library("magrittr")
cdm_config <- read.csv('../cdm_config.csv', stringsAsFactors=FALSE)
c_connect <-
  dbConnect(Oracle(), cdm_config$account, cdm_config$password, cdm_config$access)
```

Run a simple test to see that the connection works. 

```{r simple-test}
dbGetQuery(c_connect, "SELECT * FROM blueherondata.observation_fact WHERE rownum < 5")
dbGetQuery(c_connect, "SELECT * FROM blueherondata.concept_dimension WHERE rownum < 5")
dbGetQuery(c_connect, "SELECT * FROM blueheronmetadata.heron_terms WHERE rownum < 5")
```

The hierarchical structure of the electronic health record is represented by the concept path, a field in the concept_dimension table. There are similar representations of the hierachical structure in the heron_terms table of the blueheronmetadata database. These include the fields c_fullname, c_dimcode, and c_tooltip. Note that c_tooltip has less cryptic names in its hierarchy than the others.

There is also a correspondance between concept_cd and c_basecode and between name_char and c_name

This table outlines the relationships.

blueherondata.concept_dimension  | blueheronmetadata.heron_terms
-------------------------------- | --------------------------------
concept_path                     | c_fullname, c_dimcode, c_tooltip
concept_cd                       | c_basecode
name_char                        | c_name



```{r count-paths}
sql_count_paths <- "
  SELECT COUNT(concept_path) 
    FROM blueherondata.concept_dimension"

sql_count_i2b2_paths <- "
  SELECT COUNT(concept_path) 
    FROM blueherondata.concept_dimension 
    WHERE concept_path LIKE '\\i2b2\\%'"

sql_count_medication_paths <- "
  SELECT COUNT(concept_path) 
    FROM blueherondata.concept_dimension 
    WHERE concept_path LIKE '\\i2b2\\Medications\\%'"

dbGetQuery(c_connect, sql_count_paths)
dbGetQuery(c_connect, sql_count_i2b2_paths)
dbGetQuery(c_connect, sql_count_medication_paths)
```

The information in the blueheronmetadata database is fairly similar.

```{r count-metadata}
sql_count_metadata_paths <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms"

sql_count_metadata_i2b2_paths <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms
    WHERE c_fullname LIKE '\\i2b2\\%'"

sql_count_metadata_medication_paths <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms
    WHERE c_fullname LIKE '\\i2b2\\Medications\\%'"

dbGetQuery(c_connect, sql_count_metadata_paths)
dbGetQuery(c_connect, sql_count_metadata_i2b2_paths)
dbGetQuery(c_connect, sql_count_metadata_medication_paths)
```

Note that c_fullname and c_dimcode are almost identical, at least in this particular database.

```{r identical}
sql_count_discrepancies <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms
    WHERE c_fullname <> c_dimcode"

sql_count_i2b2_discrepancies <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms
    WHERE
      c_fullname <> c_dimcode AND
      c_fullname LIKE '\\i2b2\\%'"

dbGetQuery(c_connect, sql_count_discrepancies)
dbGetQuery(c_connect, sql_count_i2b2_discrepancies)
```

The variable concept_cd in the blueherondata.concept_dimension table is also almost identical to the variable c_basecode in the blueheronmetadata.heron_terms table. 

Notice that there are some NULL values

```{r concept_cd-and-c_basecode}
sql_concept_cd_anti_join <- "
  SELECT concept_cd
    FROM blueherondata.concept_dimension
    LEFT JOIN blueheronmetadata.heron_terms
    ON concept_cd=c_basecode
    WHERE
      c_basecode IS NULL AND
      ROWNUM < 10"
dbGetQuery(c_connect, sql_concept_cd_anti_join)

sql_concept_cd_anti_join_2 <- "
  SELECT concept_cd
    FROM blueherondata.concept_dimension
    LEFT JOIN blueheronmetadata.heron_terms
    ON concept_cd=c_basecode
    WHERE
      c_basecode IS NULL AND
      ROWNUM < 10 AND
      concept_cd NOT LIKE 'KUMCRC%'"
dbGetQuery(c_connect, sql_concept_cd_anti_join_2)
```

Notice that there are a substantial number of mismatches when you look in the opposite direction.

```{r reverse-left-join}
sql_c_basecode_anti_join <- "
  SELECT COUNT(term_id)
    FROM blueheronmetadata.heron_terms
    LEFT JOIN blueherondata.concept_dimension
    ON concept_cd=c_basecode
    WHERE
      concept_cd IS NULL"
dbGetQuery(c_connect, sql_c_basecode_anti_join)
```

This is because c_basecode is NULL for a large number of records. Note that the COUNT function gives the number of non-null values.

```{r reverse-further-analyses}
sql_c_basecode_anti_join_2 <- "
  SELECT COUNT(c_basecode)
    FROM blueheronmetadata.heron_terms
    LEFT JOIN blueherondata.concept_dimension
    ON concept_cd=c_basecode
    WHERE
      concept_cd IS NULL"
dbGetQuery(c_connect, sql_c_basecode_anti_join_2)
```

It looks like the null values for c_basecode represent metadata for intermediate values in the hierarchy, but it is pretty hard to establish this directly.

```{r intermediate}
sql_c_basecode_anti_join_3 <- "
  SELECT c_name, c_fullname
    FROM blueheronmetadata.heron_terms
    LEFT JOIN blueherondata.concept_dimension
    ON concept_cd=c_basecode
    WHERE
      concept_cd IS NULL AND
      ROWNUM < 20"
dbGetQuery(c_connect, sql_c_basecode_anti_join_3)
```

Once you remove the NULL values, things match up perfectly.

```{r fix-mismatches}
sql_c_basecode_anti_join_4 <- "
  SELECT DISTINCT c_basecode
    FROM blueheronmetadata.heron_terms
    LEFT JOIN blueherondata.concept_dimension
    ON concept_cd=c_basecode
    WHERE
      concept_cd IS NULL AND
      c_basecode IS NOT NULL AND
      ROWNUM < 10"
dbGetQuery(c_connect, sql_c_basecode_anti_join_4)
```

The variable name_char in the blueherondata.concept_dimension table is also almost identical to the variable c_name in the blueheronmetadata.heron_terms table. Most of the discrepancies are caused with by the inclusion of something like [379 facts; 298 patients] in c_name. The remaining discrepancies seem to involve trivial punctuation, capitalization, or word order differences.

```{r name_char-and-c_name}
sql_name_char_mismatched <- "
  SELECT name_char, c_name
    FROM blueherondata.concept_dimension
    INNER JOIN blueheronmetadata.heron_terms
    ON concept_cd=c_basecode
    WHERE
      name_char != c_name AND
      ROWNUM < 10000"

mismatched <- dbGetQuery(c_connect, sql_name_char_mismatched)
names(mismatched) %<>% tolower

mismatched$c_name_x <- sub(" \\[.*?\\]$", "", mismatched$c_name)
still_mismatched <- mismatched$c_name_x != mismatched$name_char
table(still_mismatched)
for (i in which(still_mismatched)) {
  cat("\n")
  cat("\nname_char: ")
  cat(mismatched[i, "name_char"])
  cat("\nc_name_x:  ")
  cat(mismatched[i, "c_name_x"])
  cat("\nc_name:    ")
  cat(mismatched[i, "c_name"])
}
mismatched[still_mismatched, ]
```

Let's explore the hierarchy for medications, as that is a reasonably manageable size.

```{r medications}
sql_extract_medication_paths <- "
  SELECT concept_path, concept_cd, name_char 
    FROM blueherondata.concept_dimension
    WHERE concept_path LIKE '\\i2b2\\Medications\\%'"

sql_extract_metadata_medication_paths <- "
  SELECT c_fullname, c_tooltip, c_basecode, c_name 
    FROM blueheronmetadata.heron_terms
    WHERE c_fullname LIKE '\\i2b2\\Medications\\%'"

medication_paths <- dbGetQuery(c_connect, sql_extract_medication_paths)
medication_metadata <- dbGetQuery(c_connect, sql_extract_metadata_medication_paths)

names(medication_paths) <- tolower(names(medication_paths))
names(medication_metadata) <- tolower(names(medication_metadata))
```

The concept_path variable in blueherondata.concept_dimension and c_fullname,.c_dimcode, and c_tooltip variables in blueheronmetadata.heron_terms provide information about the hierarchical structure of the data. The right most segment of these paths represents the most specific category and the segments increase in generality as you read towards the left.

```{r separate-medication-paths}
library(dplyr)
library(magrittr)
library(tidyr)
medication_paths %>%
  select(-name_char) %>%
  mutate(concept_path=sub("^\\\\", "", concept_path)) %>%
  mutate(concept_path=sub("\\\\$", "", concept_path)) %>%
  sample_n(10) %>%
  separate(concept_path, into=paste0("x", 101:120), sep="\\\\") %>%
  gather("y", "z", paste0("x", 101:120), na.rm=TRUE) %>%
  arrange(concept_cd, y) -> separated_concept_path
separated_concept_path
```

Notice how c_tooltip tends to provide better descriptions within the hierarchy than either concept_path or c_fullname/c_dimcode.

```{r separate-medication-metadata}
medication_metadata %>%
  select(c_tooltip, c_basecode) %>%
  mutate(c_tooltip=sub("^\\\\", "", c_tooltip)) %>%
  mutate(c_tooltip=sub("\\\\$", "", c_tooltip)) %>%
  sample_n(10) %>%
  separate(c_tooltip, into=paste0("x", 101:120), sep="\\\\") %>%
  gather("y", "z", paste0("x", 101:120), na.rm=TRUE) %>%
  arrange(c_basecode, y) -> separated_c_fullname
separated_c_fullname

medication_metadata %>%
  select(c_tooltip, c_basecode) %>%
  mutate(c_tooltip=sub("^\\\\", "", c_tooltip)) %>%
  mutate(c_tooltip=sub("\\\\$", "", c_tooltip)) %>%
  sample_n(10) %>%
  separate(c_tooltip, into=paste0("x", 101:120), sep="\\\\") %>%
  gather("y", "z", paste0("x", 101:120), na.rm=TRUE) %>%
  arrange(c_basecode, y) -> separated_c_tooltip
separated_c_tooltip
```

Let's create a data frame that will allow you to expand any concept_cd value to include all the levels in the hierarchy.

Notice that there seems to be some repetition. This is caused by the c_tooltip not including everything except the most specific value in the hierarchy (the leaf, if you are using a tree/branch/leaf analogy).

```{r expand-data-frame}
medication_metadata %>%
  select(c_tooltip, c_basecode) %>%
  mutate(c_tooltip=sub("^\\\\", "", c_tooltip)) %>%
  mutate(c_tooltip=sub("\\\\$", "", c_tooltip)) %>%
  separate(c_tooltip, into=paste0("x", 101:120), sep="\\\\") %>%
  gather("y", "z", paste0("x", 101:120), na.rm=TRUE) %>%
  arrange(c_basecode, y) -> hierarchy_c_tooltip
head(hierarchy_c_tooltip, 100)

medication_paths[!(medication_paths$concept_cd %in% hierarchy_c_tooltip), ]


```

Save everything for later use.

```{r save-everything}
fn <- "../data/explore_hierarchy.RData"
save.image(fn)
```