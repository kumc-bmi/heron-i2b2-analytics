---
title: "Explore the EHR hierachy"
author: "Steve Simon"
date: "5/31/2018"
output: html_document
---

This program shows how to drill down through various levels of the hierarchy in the electronic health record.

Please review open_oracle.Rmd to review how to access information in an Oracle database.


```{r login-to-oracle}
library("ROracle")
cdm_config <- read.csv('../cdm_config.csv', stringsAsFactors=FALSE)
c_connect <-
  dbConnect(Oracle(), cdm_config$account, cdm_config$password, cdm_config$access)
```

Run a simple test to see that the connection works. 

```{r simple-test}
dbGetQuery(c_connect, "SELECT * FROM blueherondata.observation_fact WHERE rownum < 5")
dbGetQuery(c_connect, "SELECT * FROM blueherondata.concept_dimension WHERE rownum < 5")
dbGetQuery(c_connect, "SELECT * FROM blueheronmetadata.heron_terms WHERE rownum < 5")
```

The hierarchical structure of the electronic health record is represented by the concept path, a field in the concept_dimension table. There are similar representations of the hierachical structure in the heron_terms table of the blueheronmetadata database. These include the fields c_fullname, c_dimcode, and c_tooltip. Note that c_tooltip has less cryptic names in its hierarchy than the others.

There is also a correspondance between concept_cd and c_basecode and between name_char and c_name

This table outlines the relationships.

blueherondata.concept_dimension  | blueheronmetadata.heron_terms
-------------------------------- | --------------------------------
concept_path                     | c_fullname, c_dimcode, c_tooltip
concept_cd                       | c_basecode
name_char                        | c_name



```{r count-paths}
sql_count_paths <- "
  SELECT COUNT(concept_path) 
    FROM blueherondata.concept_dimension"

sql_count_i2b2_paths <- "
  SELECT COUNT(concept_path) 
    FROM blueherondata.concept_dimension 
    WHERE concept_path LIKE '\\i2b2\\%'"

sql_count_medication_paths <- "
  SELECT COUNT(concept_path) 
    FROM blueherondata.concept_dimension 
    WHERE concept_path LIKE '\\i2b2\\Medications\\%'"

dbGetQuery(c_connect, sql_count_paths)
dbGetQuery(c_connect, sql_count_i2b2_paths)
dbGetQuery(c_connect, sql_count_medication_paths)
```

The information in the blueheronmetadata database is fairly similar.

```{r count-metadata}
sql_count_metadata_paths <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms"

sql_count_metadata_i2b2_paths <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms
    WHERE c_fullname LIKE '\\i2b2\\%'"

sql_count_metadata_medication_paths <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms
    WHERE c_fullname LIKE '\\i2b2\\Medications\\%'"

dbGetQuery(c_connect, sql_count_metadata_paths)
dbGetQuery(c_connect, sql_count_metadata_i2b2_paths)
dbGetQuery(c_connect, sql_count_metadata_medication_paths)
```

Note that c_fullname and c_dimcode are almost identical, at least in this particular database.

```{r identical}
sql_count_discrepancies <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms
    WHERE c_fullname <> c_dimcode"

sql_count_i2b2_discrepancies <- "
  SELECT COUNT(c_fullname) 
    FROM blueheronmetadata.heron_terms
    WHERE
      c_fullname <> c_dimcode AND
      c_fullname LIKE '\\i2b2\\%'"

dbGetQuery(c_connect, sql_count_discrepancies)
dbGetQuery(c_connect, sql_count_i2b2_discrepancies)
```

```{r concept_cd-and-c_basecode}
sql_concept_cd <- "
  SELECT COUNT(DISTINCT concept_cd)
    FROM blueherondata.concept_dimension"

sql_c_basecode <- "
  SELECT COUNT(DISTINCT c_basecode)
    FROM blueheronmetadata.heron_terms"

dbGetQuery(c_connect, sql_concept_cd)
dbGetQuery(c_connect, sql_c_basecode)

sql_concept_cd_anti_join <- "
  SELECT concept_cd
    FROM blueherondata.concept_dimension
    LEFT JOIN blueheronmetadata.heron_terms
    ON concept_cd=c_basecode
    WHERE
      c_basecode IS NULL AND
      ROWNUM < 10"

sql_c_basecode_anti_join <- "
  SELECT c_basecode
    FROM blueheronmetadata.heron_terms
    LEFT JOIN blueherondata.concept_dimension
    ON concept_cd=c_basecode
    WHERE
      concept_cd IS NULL AND
      ROWNUM < 10"
  
dbGetQuery(c_connect, sql_concept_cd_anti_join)
dbGetQuery(c_connect, sql_c_basecode_anti_join)

sql_concept_cd_anti_join_2 <- "
  SELECT concept_cd
    FROM blueherondata.concept_dimension
    LEFT JOIN blueheronmetadata.heron_terms
    ON concept_cd=c_basecode
    WHERE
      c_basecode IS NULL AND
      ROWNUM < 10 AND
      concept_cd NOT LIKE 'KUMCRC%'"
dbGetQuery(c_connect, sql_concept_cd_anti_join_2)
```

Let's explore the hierarchy for medications, as that is a reasonably manageable size.

```{r medications}
sql_extract_medication_paths <- "
  SELECT concept_path, concept_cd, name_char 
    FROM blueherondata.concept_dimension
    WHERE concept_path LIKE '\\i2b2\\Medications\\%'"

sql_extract_metadata_medication_paths <- "
  SELECT c_fullname, c_tooltip, c_basecode, c_name 
    FROM blueheronmetadata.heron_terms
    WHERE c_fullname LIKE '\\i2b2\\Medications\\%'"

medication_paths <- dbGetQuery(c_connect, sql_extract_medication_paths)
medication_metadata <- dbGetQuery(c_connect, sql_extract_metadata_medication_paths)

names(medication_paths) <- tolower(names(medication_paths))
names(medication_metadata) <- tolower(names(medication_metadata))
```

There's a very close correspondance between concept_path and c_fullname.

```{r concept}
setdiff(medication_paths$concept_path, medication_metadata$c_fullname)
setdiff(medication_metadata$c_fullname, medication_paths$concept_path)
```

and for concept_cd and c_basecode

```{r cd}
setdiff(medication_paths$concept_cd, medication_metadata$c_basecode)
setdiff(medication_metadata$c_basecode, medication_paths$concept_cd)
```

but name_char and c_name don't seem to line up as nicely. Part of this is the information like "300 facts; 28 patients]" that is appended to some of the c_name values. Once these are stripped, there is only one discrepancy.

```{r name}
library(dplyr)
library(magrittr)
length(setdiff(medication_paths$name_char, medication_metadata$c_name))
length(setdiff(medication_metadata$c_name, medication_paths$name_char))

medication_paths %>%
  inner_join(medication_metadata, by=c("concept_path"="c_fullname")) %>%
  select(name_char, c_name) %>%
  mutate(name_char=sub(" \\[.*\\]$", "", name_char)) %>%
  mutate(c_name=sub(" \\[.*\\]$", "", c_name)) %>%
  filter(name_char != c_name) %>%
  mutate(x=paste(name_char, c_name, sep="||")) %>%
  select(x)
```

The concept_path variable in blueherondata.concept_dimension and c_fullname,.c_dimcode, and c_tooltip variables in blueheronmetadata.heron_terms provide information about the hierarchical structure of the data. The right most segment of these paths represents the most specific category and the segments increase in generality as you read towards the left.

```{r separate-medication-paths}
library(dplyr)
library(magrittr)
library(tidyr)
medication_paths %>%
  select(-name_char) %>%
  mutate(concept_path=sub("^\\\\", "", concept_path)) %>%
  mutate(concept_path=sub("\\\\$", "", concept_path)) %>%
  mutate(concept_cd=sub(".*:", "", concept_cd)) %>%
  sample_n(10) %>%
  separate(concept_path, into=paste0("x", 101:120), sep="\\\\") %>%
  gather("y", "z", paste0("x", 101:120), na.rm=TRUE) %>%
  arrange(concept_cd, y) -> tst1
head(tst1, n=100)
```

```{r separate-medication-metadata}
medication_metadata %>%
  select(c_tooltip, c_basecode) %>%
  mutate(c_tooltip=sub("^\\\\", "", c_tooltip)) %>%
  mutate(c_tooltip=sub("\\\\$", "", c_tooltip)) %>%
  mutate(c_basecode=sub(".*:", "", c_basecode)) %>%
  sample_n(10) %>%
  separate(c_tooltip, into=paste0("x", 101:120), sep="\\\\") %>%
  gather("y", "z", paste0("x", 101:120), na.rm=TRUE) %>%
  arrange(c_basecode, y) -> tst2
head(tst2, n=100)
```

Save everything for later use.

```{r save-everything}
fn <- "../data/explore_hierarchy.RData"
save.image(fn)
```